<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Recepci√≥n / Entrega de Veh√≠culos</title>

<style>
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:Arial,sans-serif;background:linear-gradient(135deg,#f4fdf4,#e8f5e9);padding:20px}
header{background:linear-gradient(135deg,#00a64f,#008c42);padding:25px;text-align:center;color:#fff;font-size:26px;font-weight:bold;border-radius:10px 10px 0 0}
.container{max-width:700px;margin:auto;background:#fff;padding:30px;border-radius:0 0 10px 10px}
.form-section{margin-bottom:25px;padding:20px;background:#f9f9f9;border-radius:8px;border-left:4px solid #00a64f}
label{display:block;margin-top:15px;font-weight:bold;color:#006b37}
input,textarea,select{width:100%;padding:12px;border:2px solid #00a64f;border-radius:6px}
input[type=file]{border:2px dashed #00a64f;background:#f9f9f9}
.file-preview{display:none;margin-top:10px}
.file-preview img{max-width:150px;border-radius:8px;border:2px solid #00a64f}
button{margin-top:25px;width:100%;padding:15px;background:#00a64f;border:none;color:#fff;font-size:18px;border-radius:8px;cursor:pointer}
button:disabled{background:#ccc}
.required{color:#d32f2f}
.permissions-warning{display:none;background:#fff3cd;border:1px solid #ffc107;color:#856404;padding:15px;border-radius:8px;margin-bottom:15px}
.permissions-warning.show{display:block}
#respuesta{margin-top:20px;padding:15px;border-radius:8px;font-weight:bold;text-align:center;display:none}
#respuesta.success{background:#d4edda;color:#155724;display:block}
#respuesta.error{background:#f8d7da;color:#721c24;display:block}
#respuesta.loading{background:#d1ecf1;color:#0c5460;display:block}
.autocomplete-container{position:relative}
.autocomplete-list{position:absolute;top:100%;left:0;right:0;max-height:200px;overflow-y:auto;background:#fff;border:2px solid #00a64f;border-top:none;border-radius:0 0 6px 6px;z-index:100;display:none}
.autocomplete-item{padding:12px;cursor:pointer;border-bottom:1px solid #e0e0e0}
.autocomplete-item:hover{background:#e8f5e9}
.autocomplete-item:last-child{border-bottom:none}
.autocomplete-no-results{padding:12px;color:#666;font-style:italic;text-align:center}
.tiempo-uso{background:#fff9c4;border:2px solid #fbc02d;padding:20px;border-radius:8px;margin-top:20px;display:none}
.tiempo-uso h3{color:#f57f17;margin-bottom:10px;font-size:20px}
.tiempo-uso .detalle{font-size:16px;margin:8px 0;color:#333}
.tiempo-uso .detalle strong{color:#f57f17}
.tiempo-uso .destacado{font-size:24px;font-weight:bold;color:#e65100;margin-top:15px;padding:10px;background:#fff;border-radius:6px;text-align:center}
</style>
</head>

<body>

<header>üöó Registro de Recepci√≥n / Entrega de Veh√≠culos</header>

<div class="container">

<div class="permissions-warning" id="gpsWarning">
<strong>üìç Ubicaci√≥n requerida</strong>
<p>Debes permitir la ubicaci√≥n para enviar el registro.</p>
<p><b>Sin GPS no se puede continuar.</b></p>
</div>

<form id="formDatos">

<div class="form-section">
<h3>üìã Informaci√≥n General</h3>

<label>Movimiento <span class="required">*</span></label>
<select name="movimiento" required>
<option value="">Selecciona</option>
<option>ENTRADA</option>
<option>SALIDA</option>
</select>

<label>Nombre <span class="required">*</span></label>
<input name="nombre" required>

<label>Usuario Beta <span class="required">*</span></label>
<input name="usuario" required>

<label>Tienda <span class="required">*</span></label>
<input name="tienda" required>

<label>Placa <span class="required">*</span></label>
<div class="autocomplete-container">
<input name="placa" id="inputPlaca" required style="text-transform:uppercase" autocomplete="off" placeholder="Escribe la placa...">
<div class="autocomplete-list" id="listaPlacas"></div>
</div>

<label>Marca y Submarca <span class="required">*</span></label>
<select name="marca_y_submarca" id="selectMarca" required disabled>
<option value="">Primero selecciona una placa</option>
</select>

<label>Kilometraje <span class="required">*</span></label>
<input type="number" name="kilometraje" required>

<label>Comentarios <span class="required">*</span></label>
<textarea name="comentarios" required></textarea>
</div>

<div class="form-section">
<h3>üì∏ Fotograf√≠as obligatorias</h3>

<label>1Ô∏è‚É£ Lado Derecho <span class="required">*</span></label>
<input type="file" id="fotoDerecho" accept="image/*" capture required>
<div class="file-preview" id="previewDerecho"></div>

<label>2Ô∏è‚É£ Lado Izquierdo <span class="required">*</span></label>
<input type="file" id="fotoIzquierdo" accept="image/*" capture required>
<div class="file-preview" id="previewIzquierdo"></div>

<label>3Ô∏è‚É£ Frente <span class="required">*</span></label>
<input type="file" id="fotoFrente" accept="image/*" capture required>
<div class="file-preview" id="previewFrente"></div>

<label>4Ô∏è‚É£ Atr√°s <span class="required">*</span></label>
<input type="file" id="fotoAtras" accept="image/*" capture required>
<div class="file-preview" id="previewAtras"></div>

<label>5Ô∏è‚É£ Interior <span class="required">*</span></label>
<input type="file" id="fotoInterior" accept="image/*" capture required>
<div class="file-preview" id="previewInterior"></div>

<label>6Ô∏è‚É£ Tablero <span class="required">*</span></label>
<input type="file" id="fotoTablero" accept="image/*" capture required>
<div class="file-preview" id="previewTablero"></div>

<label>7Ô∏è‚É£ Licencia <span class="required">*</span></label>
<input type="file" id="fotoLicencia" accept="image/*" capture required>
<div class="file-preview" id="previewLicencia"></div>

<label>8Ô∏è‚É£ Tarjeta de Circulaci√≥n <span class="required">*</span></label>
<input type="file" id="fotoCirculacion" accept="image/*" capture required>
<div class="file-preview" id="previewCirculacion"></div>

</div>

<button id="btnEnviar">üì§ Enviar Registro</button>
</form>

<div id="respuesta"></div>
<div class="tiempo-uso" id="tiempoUso"></div>
</div>

<script>
const webAppUrl = "https://script.google.com/macros/s/AKfycbwpz-KfDJNPjT_u2LBT6eP4gClQ2WsbEfa160fTLlHWcqivDyTM3eUnmMzEE9CdItmJ/exec";
let vehiculosData = [];

// Cargar veh√≠culos y verificar permisos al iniciar
window.addEventListener("load", async () => {
  // Solicitar permiso de ubicaci√≥n
  try {
    await new Promise((resolve, reject) => {
      navigator.geolocation.getCurrentPosition(
        () => {
          document.getElementById("gpsWarning").classList.remove("show");
          resolve();
        },
        () => {
          document.getElementById("gpsWarning").classList.add("show");
          reject();
        },
        {enableHighAccuracy: true}
      );
    });
  } catch (error) {
    console.log("Permiso de ubicaci√≥n denegado");
  }
  
  // Cargar veh√≠culos
  try {
    const response = await fetch(webAppUrl + "?action=getVehiculos");
    vehiculosData = await response.json();
    console.log("Veh√≠culos cargados:", vehiculosData.length);
  } catch (error) {
    console.error("Error cargando veh√≠culos:", error);
  }
});

// Autocompletado de placas
const inputPlaca = document.getElementById("inputPlaca");
const listaPlacas = document.getElementById("listaPlacas");
const selectMarca = document.getElementById("selectMarca");

inputPlaca.addEventListener("input", (e) => {
  const valor = e.target.value.toUpperCase();
  inputPlaca.value = valor;
  
  if (valor.length === 0) {
    listaPlacas.style.display = "none";
    selectMarca.disabled = true;
    selectMarca.innerHTML = '<option value="">Primero selecciona una placa</option>';
    return;
  }
  
  const filtrados = vehiculosData.filter(v => 
    v.placa.toUpperCase().includes(valor)
  );
  
  if (filtrados.length > 0) {
    listaPlacas.innerHTML = "";
    filtrados.forEach(vehiculo => {
      const item = document.createElement("div");
      item.className = "autocomplete-item";
      item.innerHTML = `<strong>${vehiculo.placa}</strong> - ${vehiculo.marca}`;
      item.addEventListener("click", () => {
        inputPlaca.value = vehiculo.placa;
        selectMarca.innerHTML = `<option value="${vehiculo.marca}" selected>${vehiculo.marca}</option>`;
        selectMarca.disabled = false;
        listaPlacas.style.display = "none";
      });
      listaPlacas.appendChild(item);
    });
    listaPlacas.style.display = "block";
  } else {
    listaPlacas.innerHTML = '<div class="autocomplete-no-results">No se encontraron placas</div>';
    listaPlacas.style.display = "block";
    selectMarca.disabled = true;
    selectMarca.innerHTML = '<option value="">Placa no encontrada</option>';
  }
});

// Cerrar lista al hacer clic fuera
document.addEventListener("click", (e) => {
  if (!e.target.closest(".autocomplete-container")) {
    listaPlacas.style.display = "none";
  }
});

function convertirBase64(file){
return new Promise((res,rej)=>{
const r=new FileReader();
r.onload=()=>res(r.result);
r.onerror=e=>rej(e);
r.readAsDataURL(file);
});
}

function preview(id,p){
document.getElementById(id).addEventListener("change",e=>{
const f=e.target.files[0];
if(f){
const r=new FileReader();
r.onload=x=>{
p.innerHTML=`<img src="${x.target.result}">`;
p.style.display="block";
};
r.readAsDataURL(f);
}
});
}

["Derecho","Izquierdo","Frente","Atras","Interior","Tablero","Licencia","Circulacion"]
.forEach(f=>preview("foto"+f,document.getElementById("preview"+f)));

function mostrarTiempoUso(datos) {
  const divTiempo = document.getElementById("tiempoUso");
  
  if (!datos.tiempoUso) {
    divTiempo.style.display = "none";
    return;
  }
  
  const horas = Math.floor(datos.tiempoUso / 60);
  const minutos = datos.tiempoUso % 60;
  
  let tiempoTexto = "";
  if (horas > 0) {
    tiempoTexto = `${horas} hora${horas !== 1 ? 's' : ''} y ${minutos} minuto${minutos !== 1 ? 's' : ''}`;
  } else {
    tiempoTexto = `${minutos} minuto${minutos !== 1 ? 's' : ''}`;
  }
  
  divTiempo.innerHTML = `
    <h3>‚è±Ô∏è Control de Tiempo de Uso</h3>
    <div class="detalle"><strong>Placa:</strong> ${datos.placa}</div>
    <div class="detalle"><strong>√öltima ${datos.ultimoMovimiento}:</strong> ${datos.fechaUltimoRegistro} a las ${datos.horaUltimoRegistro}</div>
    <div class="detalle"><strong>Movimiento actual:</strong> ${datos.movimientoActual}</div>
    <div class="destacado">‚è∞ TIEMPO DE USO: ${tiempoTexto}</div>
  `;
  divTiempo.style.display = "block";
}

document.getElementById("formDatos").addEventListener("submit",async e=>{
e.preventDefault();
const btn=document.getElementById("btnEnviar");
const res=document.getElementById("respuesta");
const divTiempo = document.getElementById("tiempoUso");
btn.disabled=true;
res.className="loading";
res.innerHTML="‚è≥ Enviando...";
divTiempo.style.display = "none";

// Validar que todas las fotos est√©n cargadas
const fotosRequeridas = ["fotoDerecho","fotoIzquierdo","fotoFrente","fotoAtras","fotoInterior","fotoTablero","fotoLicencia","fotoCirculacion"];
for (let foto of fotosRequeridas) {
  if (!document.getElementById(foto).files[0]) {
    res.className="error";
    res.innerHTML="‚ùå Todas las fotograf√≠as son obligatorias";
    btn.disabled=false;
    return;
  }
}

try{
const ubicacion = await new Promise((ok,fail)=>{
navigator.geolocation.getCurrentPosition(
p=>ok({lat:p.coords.latitude,lng:p.coords.longitude}),
()=>fail("GPS_DENEGADO"),
{enableHighAccuracy:true}
);
});

const f=e.target;
const data={
fecha:new Date().toLocaleDateString("es-MX"),
hora:new Date().toLocaleTimeString("es-MX"),
movimiento:f.movimiento.value,
nombre:f.nombre.value,
usuario:f.usuario.value,
tienda:f.tienda.value,
placa:f.placa.value,
marca_y_submarca:f.marca_y_submarca.value,
kilometraje:f.kilometraje.value,
comentarios:f.comentarios.value,
latitud:ubicacion.lat,
longitud:ubicacion.lng,
fotoDerecho:await convertirBase64(fotoDerecho.files[0]),
fotoIzquierdo:await convertirBase64(fotoIzquierdo.files[0]),
fotoFrente:await convertirBase64(fotoFrente.files[0]),
fotoAtras:await convertirBase64(fotoAtras.files[0]),
fotoInterior:await convertirBase64(fotoInterior.files[0]),
fotoTablero:await convertirBase64(fotoTablero.files[0]),
fotoLicencia:await convertirBase64(fotoLicencia.files[0]),
fotoCirculacion:await convertirBase64(fotoCirculacion.files[0])
};

const response = await fetch(webAppUrl,{method:"POST",body:JSON.stringify(data)});
const resultado = await response.json();

if (resultado.success) {
  res.className="success";
  res.innerHTML="‚úÖ Registro enviado correctamente";
  
  if (resultado.tiempoUso !== undefined) {
    mostrarTiempoUso({
      placa: data.placa,
      tiempoUso: resultado.tiempoUso,
      ultimoMovimiento: resultado.ultimoMovimiento,
      fechaUltimoRegistro: resultado.fechaUltimoRegistro,
      horaUltimoRegistro: resultado.horaUltimoRegistro,
      movimientoActual: data.movimiento
    });
  }
  
  f.reset();
  selectMarca.disabled = true;
  selectMarca.innerHTML = '<option value="">Primero selecciona una placa</option>';
  document.querySelectorAll(".file-preview").forEach(p=>p.style.display="none");
} else {
  throw new Error(resultado.error || "Error al enviar");
}

}catch(err){
if (err === "GPS_DENEGADO") {
  document.getElementById("gpsWarning").classList.add("show");
  res.className="error";
  res.innerHTML="‚ùå Debes permitir la ubicaci√≥n para enviar";
} else {
  res.className="error";
  res.innerHTML="‚ùå Error: " + err.message;
}
}
btn.disabled=false;
});
</script>

</body>
</html>

